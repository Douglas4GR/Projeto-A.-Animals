@inject ClientApiCicloAvaliativo clienteCicloAvaliativo
@inject ClientApiImportacaoAvaliacao clienteImportacao
@inject ClientApiAvaliacao clienteAvaliacao
@inject ClientApiServidor clienteServidor

@page "/avaliacoesHistorico"
@using BlazorStrap
@using System.Security
@using HttpClientService
@using Microsoft.AspNetCore.JsonPatch
@using RH.Models
@using Util.Models
@inject IBlazorStrap _blazorStrap
@rendermode InteractiveAuto

<PageTitle>Histórico de Avaliações</PageTitle>
<BlazorStrap.V5.BSToaster Position="ToastPosition" ZIndex="ZIndex" />

<div class="container-fluid">
    <div class="row justify-content-center">
        <!-- ÁREA DE CONTROLE DE AVALIAÇÕES -->
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h2 class="text-dark text-center mt-2 Ghotam">Histórico de Avaliações</h2>
                </div>
                <div class="card-body">
                    @if (vinculo != null && importacaoAvaliacao != null)
                    {
                        <table class="mb-auto table table-bordered">
                            <thead>
                                <tr class="row">
                                    <!-- coluna do titulo 1 -->
                                    <td class="col-2 align-content-center">
                                        <h5 class="mb-0">ID Funcional: @vinculo.Servidor.IdFuncional</h5>
                                    </td>
                                    <!-- coluna do titulo 2 -->
                                    <td class="col-3 align-content-center">
                                        <h5 class="mb-0">Nome: @vinculo.Servidor.Nome</h5>
                                    </td>
                                    <!-- coluna do titulo 3 -->
                                    <td class="col-auto align-content-center">
                                        <div class="row">
                                            <div class="col-auto" style="padding-right: 0px;">
                                                <h5 class="mb-0 mt-2">Ciclo:</h5>
                                            </div>
                                            <div class="col-auto align-content-center">
                                                @if (ciclosAvaliativos.Count() > 0)
                                                {
                                                    <BSInput InputType="InputType.Select" @bind-Value="cicloSelecionadoId" @onchange="TrocarCiclo">
                                                        @foreach (var ciclo in ciclosAvaliativos)
                                                        {
                                                            <option value="@ciclo.Id">@ciclo.AnoBase</option>
                                                        }
                                                    </BSInput>
                                                }
                                                else
                                                {
                                                    <span>Carregando ciclos avaliativos...</span>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                    <!-- coluna do titulo 4 -->
                                    <td class="col-auto align-content-center">
                                        <div class="row">
                                            <div class="col-auto" style="padding-right: 0px;">
                                                <h5 class="mb-0 mt-2">Imprimir avaliação:</h5>
                                            </div>
                                            <div class="col-auto">
                                                <button class="btn btn-primary align-self-center justify-self-center" onclick="">Imprimir</button>
                                            </div>
                                        </div>
                                    </td>
                                    <!-- coluna do titulo 5 -->
                                    @if ((bool)importacaoAvaliacao.Avaliacoes[0].Ciencia!)
                                    {
                                        <td class="col bg-success text-white text-end align-content-center">Você deu ciência desta avaliação no dia @importacaoAvaliacao.Avaliacoes[0].LogCiencia</td>
                                    }
                                    else
                                    {
                                        <td class="col bg-danger text-white text-end align-content-center">Você não deu ciência desta avaliação!</td>
                                    }
                                </tr>
                            </thead>
                        </table>
                    }
                    else
                    {
                        <span>Carregando...</span>
                    }
                </div>
            </div>
        </div>
        @if (CarregandoAvaliacao)
        {
            <!-- spinner do bootstrap -->
            <div class="col-12 mt-5">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            </div>
        }
        else if (importacaoAvaliacao is null)
        {
            <!-- caso ainda não haja avaliação para a matricula -->
            <div class="row justify-content-center">
                <div class="col-auto mt-5">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="Ghotam">Nenhuma avaliação encontrada para esta matrícula neste Ciclo!</h3>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <AvaliacaoComponent vinculo="@vinculo" importacaoAvaliacao="@importacaoAvaliacao"/>
            <!-- AVALIAÇÃO PROPRIAMENTE DITA -->
            <div class="col-12 mt-5 mb-4">
                <div class="card">
                    <div class="card-body">
                        <table class="mb-auto table table-bordered">
                            <thead>
                                <tr>
                                    <th>
                                        <img src="bootstrap/secrEstado.png" alt="Logo da Secretaria de Estado de Educação" class="img-fluid" style="width:400px" />
                                    </th>
                                    <td class="bg-secondary-subtle border border-secondary-subtle">
                                        <h3 class="text-center Ghotam bg-secondary-subtle">
                                            FICHA DE AVALIAÇÃO PERIÓDICA/ESPECIAL DE DESEMPENHO
                                        </h3>
                                        <h4 class="text-center Ghotam bg-secondary-subtle">
                                            CHEFIA IMEDIATA
                                        </h4>
                                    </td>
                                </tr>
                            </thead>
                        </table>
                        <table class="mb-auto table table-bordered">
                            <tr>
                                <td colspan="2">
                                    <h4 class="text-center Ghotam bg-secondary-subtle border border-secondary-subtle mb-auto">
                                        IDENTIFICAÇÃO DO SERVIDOR
                                    </h4>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <table class="mb-auto table table-bordered">
                                        <tbody>
                                            <tr>
                                                <td>
                                                    <h5>Nome: @vinculo.Servidor.Nome</h5>
                                                </td>
                                                <td>
                                                    <h5>ID Funcional: @vinculo.Servidor.IdFuncional</h5>
                                                </td>
                                                <td>
                                                    <h5>Data de Início: @vinculo.Servidor.Datainicio</h5>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <h5>Carreira: @importacaoAvaliacao.Carreira.TipoCarreira</h5>
                                                </td>
                                                <td>
                                                    <h5>Cargo: @importacaoAvaliacao.Cargo.TipoCargo</h5>
                                                </td>
                                                <td>
                                                    <h5>Disciplina: @importacaoAvaliacao.DisciplinaArea.Descricao</h5>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <h5>Área de Atuação: @importacaoAvaliacao.AreaAtividade.TipoArea</h5>
                                                </td>
                                                <td>
                                                    <h5>Unidade: @importacaoAvaliacao.Unidade.TipoUnidade</h5>
                                                </td>
                                                <td>
                                                    <h5>Telefone: @importacaoAvaliacao.Unidade.Telefone</h5>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                            <tr class="text-center">
                                <th class="bg-secondary-subtle border border-secondary-subtle Ghotam display-6">
                                    AVALIAÇÃO:
                                </th>
                                <td class="border border-secondary-subtle col-3">
                                    @if (CicloAtual is not null)
                                    {
                                        <p>
                                            Período: @CicloAtual.PeriodoIni à @CicloAtual.PeriodoFim
                                        </p>
                                    }
                                    else
                                    {
                                        <p>
                                            Período sem registro de data.
                                        </p>
                                    }
                                </td>
                            </tr>
                        </table>
                        <table class="mb-auto table table-bordered">
                            <thead class="Ghotam">
                                <tr class="text-center align-middle">
                                    <th class="col-2 bg-secondary-subtle border border-secondary-subtle" colspan="2">Fatores</th>
                                    <th class="col-6 bg-secondary-subtle border border-secondary-subtle">Descrição</th>
                                    <th class="col-1 bg-secondary-subtle border border-secondary-subtle">Não Atendeu Expectativas</th>
                                    <th class="col-1 bg-secondary-subtle border border-secondary-subtle">Atendeu parcialmente expectativas</th>
                                    <th class="col-1 bg-secondary-subtle border border-secondary-subtle">Atendeu expectativas</th>
                                    <th class="col-1 bg-secondary-subtle border border-secondary-subtle">Superou expectativas</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- FREQUENCIA -->
                                <tr>
                                    <th rowspan="2" class="text-center align-middle Ghotam">I. Assiduidade</th>
                                    <td>Frequência</td>
                                    <td>Comparecimento diário ao local de trabalho para o cumprimento de suas atribuições</td>
                                    @for (int i = 1; i <= 4; i++)
                                    {
                                        <td class="text-center align-middle @(i == importacaoAvaliacao.Avaliacoes[0].Frequencia ? "bg-secondary text-white" : "")">@i</td>
                                    }
                                </tr>
                                <!-- PONTUALIDADE -->
                                <tr>
                                    <td>Pontualidade</td>
                                    <td>Observância dos horários estabelecidos para o cumprimento de suas atribuições</td>
                                    @for (int i = 1; i <= 4; i++)
                                    {
                                        <td class="text-center align-middle @(i == importacaoAvaliacao.Avaliacoes[0].Pontualidade ? "bg-secondary text-white" : "")">@i</td>
                                    }
                                </tr>
                                <!-- DISCIPLINA -->
                                <tr>
                                    <th rowspan="2" class="text-center align-middle Ghotam">II. Disciplina</th>
                                    <td>Cumprimento</td>
                                    <td>Capacidade para observar e cumprir as normas e regulamentos</td>
                                    @for (int i = 1; i <= 4; i++)
                                    {
                                        <td class="text-center align-middle @(i == importacaoAvaliacao.Avaliacoes[0].Cumprimento ? "bg-secondary text-white" : "")">@i</td>
                                    }
                                </tr>
                                <!-- ATENDIMENTO -->
                                <tr>
                                    <td>Atendimento</td>
                                    <td>Observância do contato cordial, respeito à individualidade, acompanhamento e retorno aos solicitantes dos serviços de sua responsabilidade</td>
                                    @for (int i = 1; i <= 4; i++)
                                    {
                                        <td class="text-center align-middle @(i == importacaoAvaliacao.Avaliacoes[0].Atendimento ? "bg-secondary text-white" : "")">@i</td>
                                    }
                                </tr>
                                <!-- INICIATIVA CRIATIVIDADE -->
                                <tr>
                                    <th colspan="2" class="Ghotam">III. Iniciativa/Criatividade</th>
                                    <td>Capacidade para se antecipar aos fatos e empreender alternativas inovadoras no desenvolvimento de suas atividades e para a solução de problemas de trabalho</td>
                                    @for (int i = 1; i <= 4; i++)
                                    {
                                        <td class="text-center align-middle @(i == importacaoAvaliacao.Avaliacoes[0].Criatividade ? "bg-secondary text-white" : "")">@i</td>
                                    }
                                </tr>
                                <!-- QUALIDADE DE TRABALHIO -->
                                <tr>
                                    <th rowspan="3" class="text-center align-middle Ghotam">IV. Qualidade do trabalho</th>
                                    <td>Presteza</td>
                                    <td>Pronto atendimento às solicitações e grau de precisão dispensados às atividades sob sua responsabilidade</td>
                                    @for (int i = 1; i <= 4; i++)
                                    {
                                        <td class="text-center align-middle @(i == importacaoAvaliacao.Avaliacoes[0].Presteza ? "bg-secondary text-white" : "")">@i</td>
                                    }
                                </tr>
                                <!-- INTERESSE -->
                                <tr>
                                    <td>Interesse</td>
                                    <td>Empenho demonstrado em conhecer as atividades relacionadas com os objetivos de sua área de trabalho, delas participar e nelas se envolver</td>
                                    @for (int i = 1; i <= 4; i++)
                                    {
                                        <td class="text-center align-middle @(i == importacaoAvaliacao.Avaliacoes[0].Interesse ? "bg-secondary text-white" : "")">@i</td>
                                    }
                                </tr>
                                <!-- COOPERAÇÃO -->
                                <tr>
                                    <td>Cooperação</td>
                                    <td>Disponibilidade em colaborar voluntariamente com colegas ou grupos, atendendo às solicitações do trabalho</td>
                                    @for (int i = 1; i <= 4; i++)
                                    {
                                        <td class="text-center align-middle @(i == importacaoAvaliacao.Avaliacoes[0].Cooperacao ? "bg-secondary text-white" : "")">@i</td>
                                    }
                                </tr>
                                <!-- COMPROMISSO -->
                                <tr>
                                    <th rowspan="2" class="text-center align-middle Ghotam">V. Responsabilidade</th>
                                    <td>Compromisso</td>
                                    <td>Nível de atenção demonstrada no cumprimento de suas atribuições, na observância dos prazos e no alcance dos resultados estabelecidos</td>
                                    @for (int i = 1; i <= 4; i++)
                                    {
                                        <td class="text-center align-middle @(i == importacaoAvaliacao.Avaliacoes[0].Compromisso ? "bg-secondary text-white" : "")">@i</td>
                                    }
                                </tr>
                                <!-- ZELO -->
                                <tr>
                                    <td>
                                        Zelo
                                    </td>
                                    <td>Cuidado na guarda de documentos e informações institucionais, como também na conservação de bens sob sua responsabilidade</td>
                                    @for (int i = 1; i <= 4; i++)
                                    {
                                        <td class="text-center align-middle @(i == importacaoAvaliacao.Avaliacoes[0].Zelo ? "bg-secondary text-white" : "")">@i</td>
                                    }
                                </tr>
                            </tbody>
                        </table>
                        <table class="mb-auto table table-bordered text-center align-middle">
                            <tbody>
                                <tr>
                                    <th class="bg-secondary-subtle border border-secondary-subtle Ghotam text-end">
                                        Somatório de Pontos por Indicador:
                                    </th>
                                    <td class="col-1">
                                        @importacaoAvaliacao.Avaliacoes[0].ListaPontuacoesAvaliacao.Where(x => x == 1).Sum()
                                        ponto(s)
                                    </td>
                                    <td class="col-1">
                                        @importacaoAvaliacao.Avaliacoes[0].ListaPontuacoesAvaliacao.Where(x => x == 2).Sum()
                                        ponto(s)
                                    </td>
                                    <td class="col-1">
                                        @importacaoAvaliacao.Avaliacoes[0].ListaPontuacoesAvaliacao.Where(x => x == 3).Sum()
                                        ponto(s)
                                    </td>
                                    <td class="col-1">
                                        @importacaoAvaliacao.Avaliacoes[0].ListaPontuacoesAvaliacao.Where(x => x == 4).Sum()
                                        ponto(s)
                                    </td>
                                </tr>
                                <tr>
                                    <th class="bg-secondary-subtle border border-secondary-subtle Ghotam text-end">
                                        Total de Pontos Obtidos:
                                    </th>
                                    <td colspan="4">
                                        @importacaoAvaliacao.Avaliacoes[0].ListaPontuacoesAvaliacao.Sum()
                                        ponto(s)
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="5" class="bg-secondary-subtle border border-secondary-subtle">
                                        <p class="Ghotam">Caso um ou mais fatores tenham sido avaliados como não atendendo às expectativas, que medidas foram tomadas, no período, para a melhoria de desempenho do servidor ?</p>
                                        <div class="form-floating">
                                            <textarea class="form-control" placeholder="Nenhum comentário registrado!" id="floatingTextarea" readonly></textarea>
                                            @if (string.IsNullOrEmpty(importacaoAvaliacao.Avaliacoes[0].Ocorrencias))
                                            {
                                                <label for="floatingTextarea">Nenhuma ocorrência registrada!</label>
                                            }
                                            else if (importacaoAvaliacao.Avaliacoes[0].Ocorrencias.Length > 0)
                                            {
                                                <label for="floatingTextarea"> @importacaoAvaliacao.Avaliacoes[0].Ocorrencias </label>
                                            }
                                        </div>
                                        <p>Campo para uso exclusivo do avalidador</p>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="5" class="bg-secondary-subtle border border-secondary-subtle">
                                        <h6 class="Ghotam">INFORMAÇÕES SOBRE OCORRÊNCIAS RELEVANTES REGISTRADAS NO CICLO AVALIATIVO</h6>
                                        <div class="form-floating">
                                            <textarea class="form-control" placeholder="Nenhum comentário registrado!" id="floatingTextarea2" readonly></textarea>
                                            @if (string.IsNullOrEmpty(importacaoAvaliacao.Avaliacoes[0].Observacoes))
                                            {
                                                <label for="floatingTextarea2">Nenhuma observação registrada!</label>
                                            }
                                            else if (importacaoAvaliacao.Avaliacoes[0].Observacoes.Length > 0)
                                            {
                                                <label for="floatingTextarea2"> @importacaoAvaliacao.Avaliacoes[0].Observacoes </label>
                                            }
                                        </div>
                                        <p>Campo para uso exclusivo do Setor de Pessoal da unidade de lotação do avaliado</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <table class="mb-auto table table-bordered text-center align-middle">
                            <tbody>
                                <tr>
                                    <td>
                                        <p class="mt-4">___________________________________________</p>
                                        <p>Avaliador: @importacaoAvaliacao.Avaliacoes[0].Avaliador_Servidor.Nome</p>
                                        <p class="text-end" style="padding-right: 60px;">Data: __/__/____</p>
                                    </td>
                                    <td>
                                        <p class="mt-4">___________________________________________</p>
                                        <p>Avaliado: @vinculo.Servidor.Nome</p>
                                        <p class="text-end" style="padding-right: 60px;">Data: __/__/____</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- DAR CIENCIA -->
            @if (!(bool)importacaoAvaliacao.Avaliacoes[0].Ciencia)
            {
                <div class="col-auto mb-5">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="text-dark text-center mt-2 Ghotam">Confirmação da Avaliação:</h3>
                        </div>
                        <div class="card-body">
                            <div class="row justify-content-center">
                                <div class="col-auto">
                                    <button class="btn btn-danger" @onclick="ConfirmarCiencia">Confirmar Ciência</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>




@code {
    [Parameter]
    public Matricula vinculo { get; set; } = new Matricula { Vinculo = 1};
    public ImportacaoAvaliacao importacaoAvaliacao { get; set; }


    private bool carregando { get; set; } = true;
    private bool CarregandoAvaliacao { get; set; } = true;
    private int cicloSelecionadoId { get; set; } = 0;
    private CicloAvaliativo CicloAtual { get; set;}
    private List<CicloAvaliativo> ciclosAvaliativos { get; set; } = new List<CicloAvaliativo>();
    private List<Avaliacao> avaliacao { get; set; } = new List<Avaliacao>();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            CarregandoAvaliacao = true;
            await AtualizarCiclosAvaliativos();
            await TrocarCicloMaisRecente();
            CarregandoAvaliacao = false;
        }
        catch (SecurityException e)
        {
            await autenticacao_service.LogOffAsync();
            LancarErroToast(e);
        }
        catch (Exception ex)
        {
            LancarErroToast(ex);
        }
    }


    public async Task AtualizarCiclosAvaliativos()
    {
        // Obtém a lista completa de ciclos avaliativos, ordenada pelo períodoIni de forma decrescente
        ciclosAvaliativos = await clienteCicloAvaliativo.getCicloAvaliativoAsync("?$orderby=periodoIni desc", await autenticacao_service.GetAuthenticationStateAsync());
    }

    public async Task TrocarCicloMaisRecente()
    {
        // Seleciona o ciclo mais recente
        CicloAvaliativo cicloMaisRecente = ciclosAvaliativos.FirstOrDefault();

        if (cicloMaisRecente != null)
        {
            // Carrega a avaliação do ciclo mais recente
            await LoadImportacaoAvaliacao(cicloMaisRecente.Id);
        }
    }

    private async Task TrocarCiclo(ChangeEventArgs args)
    {
        if (int.TryParse(args.Value.ToString(), out int novoCicloId))
        {
            cicloSelecionadoId = novoCicloId;
            await LoadImportacaoAvaliacao(novoCicloId);
        }
    }

    async Task LoadImportacaoAvaliacao(int CicloID)
    {
        var importacoes = await clienteImportacao.getImportacaoAvaliacaoAsync($"?$filter=MatriculaId eq {vinculo.Id} & cicloAvaliativoId eq {CicloID} & $expand=Carreira,Cargo,DisciplinaArea,AreaAtividade,Unidade,Avaliacoes($filter=AvaliacaoRecursoId eq null;$expand=Avaliador_Servidor)"
    , await autenticacao_service.GetAuthenticationStateAsync());
        importacaoAvaliacao = importacoes.FirstOrDefault();
    }


    async void ConfirmarCiencia()
    {
        var avaliacao = new JsonPatchDocument<Avaliacao>();
        avaliacao.Replace(x => x.Ciencia, true);
        await clienteAvaliacao.patchAvaliacaoAsync($"/{importacaoAvaliacao.Avaliacoes[0].Id.ToString()}", await autenticacao_service.GetAuthenticationStateAsync(), avaliacao);
       
    }



    //propriedades da Toast
    private Position ToastPosition { get; set; } = Position.Fixed;
    private int ZIndex { get; set; } = 1025;
    private void LancarErroToast(Exception e)
    {
        _blazorStrap.Toaster.Add("Falha", e.Message, o =>
        {
            o.Color = BSColor.Danger;
            o.CloseAfter = 5000;
            o.Toast = Toast.Default;
            o.HasIcon = true;
        });
    }


    //mensagens de pontuação
    private string mensagemPontuacao1 = "Não atendeu às espectativas";
    private string mensagemPontuacao2 = "Atendeu parcialmente às espectativas";
    private string mensagemPontuacao3 = "Atendeu às espectativas";
    private string mensagemPontuacao4 = "Superou às espectativas";
}
